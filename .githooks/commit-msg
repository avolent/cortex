#!/usr/bin/env bash
#
# Git commit-msg hook for semantic versioning validation
# Validates commit messages against conventional commits format
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Skip validation for merge commits
if echo "$COMMIT_MSG" | grep -qE "^Merge (branch|remote-tracking branch)"; then
    exit 0
fi

# Skip validation for revert commits (they have their own format)
if echo "$COMMIT_MSG" | grep -qE "^Revert "; then
    exit 0
fi

# Conventional commit pattern
# Format: type(scope): subject
PATTERN="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .{1,100}"

# Extract first line (header)
HEADER=$(echo "$COMMIT_MSG" | head -n1)

# Validate commit message format
if ! echo "$HEADER" | grep -qE "$PATTERN"; then
    echo -e "${RED}❌ Invalid commit message format${NC}"
    echo
    echo -e "${YELLOW}Your commit message:${NC}"
    echo "  $HEADER"
    echo
    echo -e "${YELLOW}Expected format:${NC}"
    echo "  <type>(<scope>): <subject>"
    echo
    echo -e "${YELLOW}Valid types:${NC}"
    echo "  feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
    echo
    echo -e "${YELLOW}Examples:${NC}"
    echo "  feat(auth): add user authentication"
    echo "  fix(api): resolve timeout issue"
    echo "  docs(readme): update installation steps"
    echo
    echo -e "${YELLOW}For breaking changes:${NC}"
    echo "  feat!: redesign API"
    echo "  fix(api)!: change response format"
    echo
    echo "See CONTRIBUTING.md for detailed guidelines"
    exit 1
fi

# Additional validations
TYPE=$(echo "$HEADER" | sed -E 's/^([a-z]+).*/\1/')
SUBJECT=$(echo "$HEADER" | sed -E 's/^[a-z]+(\([^)]+\))?!?: (.+)/\2/')

# Check subject doesn't end with period
if echo "$SUBJECT" | grep -qE '\.$'; then
    echo -e "${RED}❌ Subject line must not end with a period${NC}"
    echo "  Got: $SUBJECT"
    exit 1
fi

# Check subject is not empty
if [ -z "$SUBJECT" ] || [ "$SUBJECT" = " " ]; then
    echo -e "${RED}❌ Subject cannot be empty${NC}"
    exit 1
fi

# Check header length
if [ ${#HEADER} -gt 100 ]; then
    echo -e "${RED}❌ Header too long (${#HEADER} chars, max 100)${NC}"
    echo "  $HEADER"
    exit 1
fi

# Success
echo -e "${GREEN}✓${NC} Commit message format is valid"
exit 0
